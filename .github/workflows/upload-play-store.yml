name: Upload to Play Store

on:
  workflow_dispatch:
    inputs:
      flavor:
        description: 'App flavor to build and upload'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
      track:
        description: 'Play Store track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
      release_notes:
        description: 'Release notes (optional)'
        required: false
        default: 'Bug fixes and improvements'
      status:
        description: 'Release status (draft for new apps, completed to roll out)'
        required: true
        default: 'draft'
        type: choice
        options:
          - draft
          - completed

env:
  NODE_VERSION: '22'
  JAVA_VERSION: '21'

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Get version from package.json
        id: version
        working-directory: frontend
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Create environment file
        working-directory: frontend
        env:
          FIREBASE_CONFIG: ${{ secrets.FIREBASE_CLIENT_CONFIG }}
        run: |
          # Determine build mode and API URL based on flavor
          if [ "${{ inputs.flavor }}" = "prod" ]; then
            BUILD_MODE="production"
            API_URL="https://cally-backend-prod-4gadwws45a-uc.a.run.app/api"
          else
            BUILD_MODE="dev"
            API_URL="https://cally-backend-dev-4gadwws45a-uc.a.run.app/api"
          fi

          echo "Creating .env.$BUILD_MODE with API URL: $API_URL"
          echo "VITE_API_URL=$API_URL" > .env.$BUILD_MODE

          # Write Firebase config via environment variable (safest method)
          echo "VITE_FIREBASE_CONFIG=$FIREBASE_CONFIG" >> .env.$BUILD_MODE

          # Verify env file was created
          echo "Environment file created: .env.$BUILD_MODE"
          echo "File size: $(wc -c < .env.$BUILD_MODE) bytes"
          echo "Line count: $(wc -l < .env.$BUILD_MODE) lines"

      - name: Build web assets
        working-directory: frontend
        env:
          VERSION_CODE: ${{ github.run_number }}00
        run: |
          if [ "${{ inputs.flavor }}" = "prod" ]; then
            npm run build -- --mode production
          else
            npm run build -- --mode dev
          fi

      - name: Verify build output
        working-directory: frontend
        run: |
          echo "Checking dist/ directory..."
          ls -lah dist/

          # Verify index.html exists
          if [ ! -f "dist/index.html" ]; then
            echo "ERROR: dist/index.html not found!"
            exit 1
          fi

          # Check if Firebase config is in the bundle (search for projectId)
          if grep -r "cally-658" dist/assets/*.js > /dev/null 2>&1; then
            echo "✓ Firebase config found in build"
          else
            echo "⚠ WARNING: Firebase config may not be embedded in build"
          fi

          echo "Build verification complete"

      - name: Update Capacitor config
        working-directory: frontend
        run: |
          # Determine app configuration based on flavor
          if [ "${{ inputs.flavor }}" = "prod" ]; then
            APP_ID="com.getkalli.app"
            APP_NAME="Kalli"
          else
            APP_ID="com.kalli.app.dev"
            APP_NAME="Kalli (Dev)"
          fi

          # Create capacitor config
          cat > capacitor.config.json << EOF
          {
            "appId": "$APP_ID",
            "appName": "$APP_NAME",
            "webDir": "dist",
            "server": {
              "androidScheme": "https"
            },
            "plugins": {
              "Keyboard": {
                "resize": "native",
                "style": "dark",
                "resizeOnFullScreen": true
              },
              "StatusBar": {
                "overlay": true
              },
              "SystemBars": {
                "insetsHandling": "disable"
              }
            }
          }
          EOF

          cat capacitor.config.json

      - name: Add Capacitor Android platform
        working-directory: frontend
        run: |
          # Remove any existing android directory to avoid prompts
          rm -rf android
          npx cap add android

      - name: Sync Capacitor
        working-directory: frontend
        run: |
          npx cap sync android
          echo "✓ Capacitor sync complete"

      - name: Copy custom Android assets
        working-directory: frontend
        run: |
          cp -R android-assets/res/mipmap-* android/app/src/main/res/
          echo "✓ Custom launcher icons copied"

      - name: Configure release signing and versioning
        working-directory: frontend/android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          # Decode keystore to app directory (printf avoids echo mangling base64)
          printf '%s' "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/release.keystore
          ls -la app/release.keystore

          # Validate keystore was decoded correctly
          if ! keytool -list -keystore app/release.keystore -storepass "$KEYSTORE_PASSWORD" -storetype PKCS12 > /dev/null 2>&1; then
            echo "ERROR: Failed to read keystore. Check KEYSTORE_BASE64 and KEYSTORE_PASSWORD secrets."
            exit 1
          fi
          echo "✓ Keystore validated successfully"

          # Update versionCode (run_number * 100 - allows ~100 manual uploads between CI runs)
          VERSION_CODE=$(( ${{ github.run_number }} * 100 ))
          sed -i "s/versionCode 1/versionCode $VERSION_CODE/" app/build.gradle

          # Update versionName to match package.json
          sed -i 's/versionName "1.0"/versionName "${{ steps.version.outputs.version }}"/' app/build.gradle

          echo "Set versionCode=$VERSION_CODE (run #${{ github.run_number }} x 100), versionName=${{ steps.version.outputs.version }}"

          # Write signing credentials to gradle.properties
          cat >> gradle.properties << PROPS

          # Signing credentials (added by CI)
          KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD}
          KEY_ALIAS=${KEY_ALIAS}
          KEY_PASSWORD=${KEY_PASSWORD}
          PROPS
          echo "✓ Signing credentials written to gradle.properties"

          # Inject signingConfigs block before buildTypes in build.gradle
          SIGNING_BLOCK='    signingConfigs {\n        release {\n            storeFile file("release.keystore")\n            storeType "PKCS12"\n            storePassword project.hasProperty("KEYSTORE_PASSWORD") ? project.KEYSTORE_PASSWORD : ""\n            keyAlias project.hasProperty("KEY_ALIAS") ? project.KEY_ALIAS : ""\n            keyPassword project.hasProperty("KEY_PASSWORD") ? project.KEY_PASSWORD : ""\n        }\n    }\n'
          sed -i "s|    buildTypes {|${SIGNING_BLOCK}    buildTypes {|" app/build.gradle

          # Update release buildType to use signing config
          sed -i '/release {/,/}/ s/minifyEnabled false/signingConfig signingConfigs.release\n            minifyEnabled false/' app/build.gradle

          echo "✓ Updated build.gradle with signing config"
          echo "--- build.gradle signing section ---"
          grep -A 12 "signingConfigs" app/build.gradle || echo "WARNING: signingConfigs not found"

      - name: Build Release AAB
        working-directory: frontend/android
        run: |
          chmod +x ./gradlew
          echo "Building bundleRelease for ${{ inputs.flavor }} (appId set via Capacitor config)..."
          ./gradlew bundleRelease

      - name: Upload AAB as artifact
        uses: actions/upload-artifact@v4
        with:
          name: kalli-${{ inputs.flavor }}-release-${{ steps.version.outputs.version }}-${{ github.run_number }}
          path: frontend/android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 90

      - name: Determine package name
        id: package
        run: |
          if [ "${{ inputs.flavor }}" = "prod" ]; then
            echo "name=com.getkalli.app" >> $GITHUB_OUTPUT
          else
            echo "name=com.kalli.app.dev" >> $GITHUB_OUTPUT
          fi

      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ steps.package.outputs.name }}
          releaseFiles: frontend/android/app/build/outputs/bundle/release/app-release.aab
          track: ${{ inputs.track }}
          status: ${{ inputs.status }}
          releaseName: v${{ steps.version.outputs.version }}${{ inputs.flavor == 'dev' && '-dev' || '' }}
          whatsNewDirectory: ''
          inAppUpdatePriority: 0

      - name: Build Summary
        run: |
          if [ "${{ inputs.flavor }}" = "prod" ]; then
            PACKAGE_NAME="com.kalli.app"
            API_URL="https://cally-backend-prod-4gadwws45a-uc.a.run.app/api"
          else
            PACKAGE_NAME="com.kalli.app.dev"
            API_URL="https://cally-backend-dev-4gadwws45a-uc.a.run.app/api"
          fi
          echo "## Play Store Upload Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Flavor** | ${{ inputs.flavor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | v${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version Code** | ${{ github.run_number }} x 100 = $(( ${{ github.run_number }} * 100 )) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Track** | ${{ inputs.track }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ inputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Package** | $PACKAGE_NAME |" >> $GITHUB_STEP_SUMMARY
          echo "| **API URL** | $API_URL |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [Play Console](https://play.google.com/console) for release status." >> $GITHUB_STEP_SUMMARY
